<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQT é—˜æŠ€å ´ã¾ã¨ã‚ç”»åƒç”Ÿæˆ</title>
    <style type="text/css">
        /* style.cssã®å†…å®¹ã‚’ã“ã“ã«åŸ‹ã‚è¾¼ã¿ã¾ã™ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding-top: 1rem; /* remã«å¤‰æ›´ */
            padding-bottom: 3rem; /* remã«å¤‰æ›´ã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã§éš ã‚Œãªã„ã‚ˆã†ã«å°‘ã—å¢—ã‚„ã™ */
            padding-left: 0.5rem; /* å·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            padding-right: 0.5rem; /* å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            font-size: 16px; /* ãƒ™ãƒ¼ã‚¹ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’remã®åŸºæº–ã¨ã—ã¦è¨­å®š */
        }

        h1, h2 {
            color: #007bff;
            margin-bottom: 0.5em; /* ç›¸å¯¾å˜ä½ */
        }
        h1 {
            text-align: center;
            margin-bottom: 1em; /* ç›¸å¯¾å˜ä½ */
            font-size: clamp(1.5rem, 4.5vw, 2.2rem); /* æœ€å°ã€æ¨å¥¨ã€æœ€å¤§ã‚µã‚¤ã‚ºã«èª¿æ•´ */
        }
        h2 {
            font-size: clamp(1.2rem, 3.8vw, 1.8rem); /* æœ€å°ã€æ¨å¥¨ã€æœ€å¤§ã‚µã‚¤ã‚ºã«èª¿æ•´ */
        }

        .card {
            background-color: #fff;
            padding: 1.5rem; /* remã«å¤‰æ›´ */
            margin-bottom: 1.5rem; /* remã«å¤‰æ›´ */
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .info {
            font-size: 0.85rem; /* remã«å¤‰æ›´ */
            color: #555;
            margin-top: 0.5rem; /* remã«å¤‰æ›´ */
        }

        #imageUpload {
            display: block;
            margin-top: 1rem; /* remã«å¤‰æ›´ */
            padding: 0.8rem; /* remã«å¤‰æ›´ */
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9;
            font-size: 0.9rem; /* remã«å¤‰æ›´ */
            /* iPhone13ã§ã¯ã¿å‡ºãªã„ã‚ˆã†ã«æ¨ªå¹…ã‚’èª¿æ•´ */
            width: calc(100% - 1.6rem); /* paddingåˆ†ã‚’è€ƒæ…®ã—ã¦100%ã‹ã‚‰å¼•ã */
            max-width: 400px; /* ã‚ã‚‹ç¨‹åº¦ã®æœ€å¤§å¹…ã‚’è¨­å®šï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã®éåº¦ãªæ‹¡å¤§ã‚’é˜²æ­¢ï¼‰ */
            box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ã¦å¹…ã‚’è¨ˆç®— */
        }
        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘ã«ã•ã‚‰ã«èª¿æ•´ãŒå¿…è¦ãªå ´åˆ */
        @media (max-width: 400px) { /* iPhone 13 Proã®å¹…ãªã©ã€ã‚¹ãƒãƒ›ã®å®Ÿéš›ã®å¹…ã‚’æƒ³å®š */
            #imageUpload {
                width: calc(100% - 1.6rem); /* ç”»é¢å¹…ã®ã»ã¨ã‚“ã©ã‚’ä½¿ã†ãŒã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆ†ã‚’å¼•ã */
            }
        }


        #fileList {
            margin-top: 1rem; /* remã«å¤‰æ›´ */
            font-size: 0.85rem; /* remã«å¤‰æ›´ */
        }
        #fileList div {
            padding: 0.3rem; /* remã«å¤‰æ›´ */
            border-bottom: 1px solid #eee;
        }
        #fileList div:last-child {
            border-bottom: none;
        }
        #fileList ol {
            padding-left: 1.25rem; /* remã«å¤‰æ›´ */
            margin-top: 0.5rem; /* remã«å¤‰æ›´ */
        }
        #fileList li {
            margin-bottom: 0.2rem; /* remã«å¤‰æ›´ */
        }

        .row-setting {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem; /* remã«å¤‰æ›´ */
            padding: 0.8rem; /* remã«å¤‰æ›´ */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
            flex-wrap: wrap; /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§è¦ç´ ãŒæŠ˜ã‚Šè¿”ã™ã‚ˆã†ã« */
        }

        /* è©¦åˆåã¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ */
        .row-setting .match-file-info {
            display: flex; /* æ¨ªä¸¦ã³ã«ã™ã‚‹ */
            align-items: baseline; /* ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’æƒãˆã‚‹ */
            flex-wrap: wrap; /* å¿…è¦ãªã‚‰æŠ˜ã‚Šè¿”ã™ */
            margin-right: 1rem; /* å¾Œç¶šã®è¦ç´ ã¨ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ */
            flex-grow: 1; /* æ®‹ã‚Šã‚¹ãƒšãƒ¼ã‚¹ã‚’å ã‚ã‚‹ */
            min-width: 200px; /* ã‚ã‚‹ç¨‹åº¦ã®æœ€å°å¹…ã‚’ç¢ºä¿ */
        }

        .row-setting .match-name-display {
            font-size: 0.9rem; /* remã«å¤‰æ›´ */
            font-weight: bold;
            color: #0056b3;
            white-space: nowrap; /* æ”¹è¡Œã—ãªã„ */
            margin-right: 0.25rem; /* ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã®é–“éš” */
            flex-shrink: 0;
        }

        .row-setting .file-name-display {
            font-size: 0.9rem; /* remã«å¤‰æ›´ */
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; /* æ”¹è¡Œã—ãªã„ */
            flex-shrink: 1; /* å¿…è¦ãªã‚‰ç¸®å° */
            min-width: 50px; /* ç¸®å°ã—ã™ããªã„ã‚ˆã†ã« */
        }

        /* ãƒã‚¤ãƒ³ãƒˆè¨­å®šéƒ¨åˆ†ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ */
        .row-setting .points-setting {
            display: flex; /* æ¨ªä¸¦ã³ã«ã™ã‚‹ */
            align-items: center;
            flex-shrink: 0; /* ç¸®å°ã•ã›ãªã„ */
            white-space: nowrap; /* æ”¹è¡Œã—ãªã„ */
        }

        .row-setting label {
            margin-right: 0.5rem; /* remã«å¤‰æ›´ */
            font-size: 0.9rem; /* remã«å¤‰æ›´ */
            white-space: nowrap;
            flex-shrink: 0;
        }

        .row-setting select {
            padding: 0.5rem 0.8rem; /* remã«å¤‰æ›´ */
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: white;
            font-size: 0.9rem; /* remã«å¤‰æ›´ */
            min-width: 60px; /* Selectãƒœãƒƒã‚¯ã‚¹ã®æœ€å°å¹… */
            flex-shrink: 0;
        }

        /* row-settingã®å­è¦ç´ ãŒæŠ˜ã‚Šè¿”ã—ãŸéš›ã®èª¿æ•´ */
        @media (max-width: 600px) {
            .row-setting {
                flex-direction: column; /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã¯ç¸¦ã«ä¸¦ã¹ã‚‹ */
                align-items: flex-start; /* å·¦å¯„ã› */
            }
            .row-setting .match-file-info {
                margin-right: 0;
                margin-bottom: 0.5rem;
                width: 100%; /* å¹…ã‚’100%ã« */
            }
            .row-setting .points-setting {
                margin-bottom: 0; /* ä¸è¦ãªãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
                width: 100%; /* å¹…ã‚’100%ã« */
                justify-content: flex-start; /* å·¦æƒãˆ */
            }
        }


        .crop-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* ç”»é¢å¹…ã«å¿œã˜ã¦åˆ—æ•°ã‚’è‡ªå‹•èª¿æ•´ã€å°‘ã—åºƒã’ã‚‹ */
            gap: 1rem; /* remã«å¤‰æ›´ */
            margin-top: 1rem; /* remã«å¤‰æ›´ */
        }

        .crop-settings-item {
            display: flex;
            align-items: center;
            gap: 0.8rem; /* remã«å¤‰æ›´ */
            /* ãƒœã‚¿ãƒ³ã¨å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å›²ã‚€ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ */
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .crop-settings-item label {
            flex-shrink: 0;
            font-size: 1rem; /* remã«å¤‰æ›´ */
            color: #333;
            margin-right: auto; /* ãƒ©ãƒ™ãƒ«ã¨å…¥åŠ›/ãƒœã‚¿ãƒ³ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è‡ªå‹•æŒ¿å…¥ */
        }

        /* Input ã¨ãƒœã‚¿ãƒ³ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ– */
        .input-with-buttons {
            display: flex;
            align-items: center;
            gap: 0.2rem; /* ãƒœã‚¿ãƒ³ã¨å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }

        .input-with-buttons input[type="number"] {
            padding: 0.5rem; /* remã«å¤‰æ›´ */
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ããã—ã¦ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
            width: 45px; /* ã“ã“ã‚’èª¿æ•´ã—ã¦æ¨ªå¹…ã‚’ç‹­ãã™ã‚‹ */
            height: 2.2rem; /* é«˜ã•ã‚‚ç¢ºä¿ã—ã¦ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
            box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ã¦å¹…ã‚’è¨ˆç®— */
            text-align: center; /* æ•°å­—ã‚’ä¸­å¤®å¯„ã› */
            -moz-appearance: textfield; /* Firefoxã§ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
        }
        /* Chrome/Safariãªã©ã§ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        .input-with-buttons input[type="number"]::-webkit-outer-spin-button,
        .input-with-buttons input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-with-buttons button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            width: 2.2rem; /* ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
            height: 2.2rem; /* ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
            font-size: 1.2rem; /* ãƒœã‚¿ãƒ³å†…ã®æ–‡å­—ã‚µã‚¤ã‚º */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0; /* ç¸®å°ã•ã›ãªã„ */
            transition: background-color 0.2s ease;
        }

        .input-with-buttons button:hover {
            background-color: #0056b3;
        }
        .input-with-buttons button:active {
            background-color: #004080;
        }


        .crop-settings-item span.unit {
            font-size: 0.85rem; /* remã«å¤‰æ›´ */
            color: #555;
            margin-left: 0.5rem; /* å˜ä½ã¨ãƒœã‚¿ãƒ³ã®é–“éš” */
        }

        /* ã²ã¨ã“ã¨å…¥åŠ›æ¬„ */
        #commentSection {
            margin-top: 1.5rem; /* ã²ã¨ã“ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
            margin-bottom: 1rem; /* ä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ  */
        }
        #commentInput {
            width: 80%; /* å¹…ã‚’èª¿æ•´ */
            min-height: 3rem; /* é«˜ã•ã‚’èª¿æ•´ */
            padding: 0.5rem; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            margin-top: 0.3rem; /* ã•ã‚‰ã«ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°‘ã—å°ã•ã */
            font-family: "Meiryo", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif; /* ãƒ¡ã‚¤ãƒªã‚ªæ›¸ä½“ */
            box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ã¦å¹…ã‚’è¨ˆç®— */
        }
        #commentSection .info {
            margin-top: 0.2rem; /* infoãƒ†ã‚­ã‚¹ãƒˆã®ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
            font-size: 0.75rem; /* infoãƒ†ã‚­ã‚¹ãƒˆã®ã‚µã‚¤ã‚ºã‚’ã•ã‚‰ã«å°ã•ã */
        }


        #generateButton {
            background-color: #28a745;
            color: white;
            padding: 0.8rem 1.5rem; /* remã«å¤‰æ›´ */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem; /* remã«å¤‰æ›´ */
            transition: background-color 0.2s ease;
            display: block;
            margin: 0 auto;
        }

        #generateButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #generateButton:hover:not(:disabled) {
            background-color: #218838;
        }

        #resultCanvas {
            border: 2px dashed #007bff;
            margin-top: 1.5rem; /* remã«å¤‰æ›´ */
            max-width: 100%;
            height: auto;
            display: block;
            background-color: #fff;
            margin-left: auto;
            margin-right: auto;
        }

        #downloadLink {
            display: none;
            margin: 1.5rem auto 0 auto; /* remã«å¤‰æ›´ */
            padding: 0.8rem 1.2rem; /* remã«å¤‰æ›´ */
            background-color: #007bff;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 6px;
            font-size: 1.05rem; /* remã«å¤‰æ›´ */
            width: fit-content;
            transition: background-color 0.2s ease;
        }

        #downloadLink:hover {
            background-color: #0056b3;
        }

        .author-info {
            margin-top: 3rem; /* remã«å¤‰æ›´ */
            padding-top: 1.25rem; /* remã«å¤‰æ›´ */
            border-top: 1px solid #e0e0e0;
            font-size: 0.85rem; /* remã«å¤‰æ›´ */
            color: #666;
            /* ãƒ†ã‚­ã‚¹ãƒˆã®ä½™ç™½ã¨å·¦æƒãˆ */
            text-align: left; /* å·¦æƒãˆ */
            padding-left: 5%; /* å·¦ã«5%ã®ä½™ç™½ */
            padding-right: 5%; /* å³ã«5%ã®ä½™ç™½ */
            max-width: 90%; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æœ€å¤§å¹…ã‚’90%ã«åˆ¶é™ */
            margin-left: auto; /* ä¸­å¤®å¯„ã› */
            margin-right: auto; /* ä¸­å¤®å¯„ã› */
            box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ã¦å¹…ã‚’è¨ˆç®— */
        }
        /* å¿…è¦ã§ã‚ã‚Œã°ã€å°ã•ãªç”»é¢ã§ã®ä½™ç™½ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ */
        @media (max-width: 600px) {
            .author-info {
                padding-left: 2%; /* ã•ã‚‰ã«ç‹­ã„ç”»é¢ã§ã¯ä½™ç™½ã‚’å°ã•ã */
                padding-right: 2%;
                max-width: 96%;
            }
        }


        .author-info p {
            margin-bottom: 0.8rem; /* remã«å¤‰æ›´ (è¡Œé–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’åºƒã’ã‚‹) */
        }
        /* æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ«: æœ€çµ‚æ›´æ–°æ—¥ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’1è¡Œã§è¡¨ç¤º */
        .author-info .version-info {
            display: flex;
            justify-content: center; /* ä¸­å¤®æƒãˆã‚’ç¶­æŒ */
            gap: 0.5rem; /* è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            flex-wrap: wrap; /* å°ã•ã„ç”»é¢ã§æŠ˜ã‚Šè¿”ã™ */
            margin-top: 1.5rem; /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®ä¸Šéƒ¨ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ  */
        }
        .author-info .version-info p {
            margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
        }

    </style>
</head>
<body>
    <h1>DQT é—˜æŠ€å ´ã¾ã¨ã‚ç”»åƒç”Ÿæˆ</h1>

    <div class="upload-section card">
        <h2>1. æŒ‘æˆ¦ç›´å‰ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
        <label for="imageUpload">ãƒãƒˆãƒ«é–‹å§‹ç›´å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’3æšã‹ã‚‰7æšé¸æŠã—ã¦ãã ã•ã„ (PNG, JPG):</label>
        <input type="file" id="imageUpload" multiple accept="image/png, image/jpeg">
        <p class="info">â€»6æšã¾ãŸã¯7æšã®å ´åˆã¯ã€Œäºˆé¸/æœ¬æˆ¦ã€è¡¨ç¤ºã€3-5æšã®å ´åˆã¯ã€Œç¬¬Xè©¦åˆã€è¡¨ç¤ºã¨ãªã‚Šã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åãŒè‹¥ã„é †ï¼ˆæ˜‡é †ï¼‰ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
        <div id="fileList"></div>
    </div>

    <div class="settings-section card">
        <h2>2. å„è©¦åˆã®æˆ¦ç¸¾ãƒã‚¤ãƒ³ãƒˆè¨­å®š</h2>
        <div id="rowsContainer">
            <p class="info">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã“ã“ã«è¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <h2>3. PTåˆ‡ã‚Šå‡ºã—ä½ç½®ã®èª¿æ•´</h2>
        <p class="info">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®è§£åƒåº¦ã«åˆã‚ã›ã¦ã€ä»¥ä¸‹ã®å€¤ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ç”»åƒã®æ¨ªå¹…ã«å¯¾ã™ã‚‹å‰²åˆã§æŒ‡å®šã—ã¾ã™ã€‚<br>
        <small>â€»iPhone 13 (ç¸¦æŒã¡) ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚</small></p>
        <div class="crop-settings-grid">
            <div class="crop-settings-item">
                <label for="cropSx">PTé–‹å§‹ä½ç½®X:</label>
                <div class="input-with-buttons">
                    <button class="decrement-btn" data-target="cropSx">-</button>
                    <input type="number" id="cropSx" value="11" min="0" max="40">
                    <button class="increment-btn" data-target="cropSx">+</button>
                </div>
                <span class="unit">%</span>
            </div>
            <div class="crop-settings-item">
                <label for="cropSOpponentY">ç›¸æ‰‹é–‹å§‹ä½ç½®Y:</label>
                <div class="input-with-buttons">
                    <button class="decrement-btn" data-target="cropSOpponentY">-</button>
                    <input type="number" id="cropSOpponentY" value="35" min="0" max="100">
                    <button class="increment-btn" data-target="cropSOpponentY">+</button>
                </div>
                <span class="unit">%</span>
            </div>
            <div class="crop-settings-item">
                <label for="cropSHeight">PTç¸¦å¹… Yå‰²åˆ:</label>
                <div class="input-with-buttons">
                    <button class="decrement-btn" data-target="cropSHeight">-</button>
                    <input type="number" id="cropSHeight" value="10" min="1" max="50">
                    <button class="increment-btn" data-target="cropSHeight">+</button>
                </div>
                <span class="unit">%</span>
            </div>
            <div class="crop-settings-item">
                <label for="cropSSelfY">è‡ªåˆ†é–‹å§‹ä½ç½®Y:</label>
                <div class="input-with-buttons">
                    <button class="decrement-btn" data-target="cropSSelfY">-</button>
                    <input type="number" id="cropSSelfY" value="49" min="0" max="100">
                    <button class="increment-btn" data-target="cropSSelfY">+</button>
                </div>
                <span class="unit">%</span>
            </div>
        </div>

        <div id="commentSection">
            <h2>4. ã²ã¨ã“ã¨(ä»»æ„)</h2>
            <textarea id="commentInput" placeholder="ã“ã“ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            <p class="info">ç”Ÿæˆç”»åƒã®ä¸‹éƒ¨ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>

    </div>

    <div class="action-section card">
        <h2>5. æˆ¦ç¸¾ã¾ã¨ã‚ç”»åƒç”Ÿæˆ</h2>
        <button id="generateButton" disabled>ç”»åƒã‚’ç”Ÿæˆ âœ¨</button>
    </div>

    <div class="result-section card">
        <h2>ç”Ÿæˆçµæœ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <canvas id="resultCanvas"></canvas>
        <a id="downloadLink">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ğŸ’¾</a>
    </div>

    <div class="author-info">
        <h3>ä½œè€… ( <a href="https://x.com/jmazeppa" target="_blank" rel="noopener noreferrer">@jmazeppa</a> ) ã‚ˆã‚Š</h3>
        <p>â€Tact Arenorâ€ã¯ã€é—˜æŠ€å ´(Arena)ã‚’æ¥½ã—ã‚€ã‚¿ã‚¯ã‚¿ãƒ¼ã¨ã„ã†æ„å‘³ã®é€ èªã§ã™ã€‚</p>
        <p>ã‚®ãƒ«ãƒ‰å¤§ä¼šãªã©ã®é—˜æŠ€å ´ã®æ”»ã‚ã¾ã¨ã‚ç”»åƒã‚’ç°¡å˜ã«ä½œæˆã™ã‚‹ãŸã‚ã«ä½œã‚Šã¾ã—ãŸãŒã€é˜²è¡›ã¯äººã«ã‚ˆã£ã¦è¦‹ã›ãŸã„ãƒ¢ãƒãŒå¤‰ã‚ã‚‹äº‹ã‚‚ã‚ã‚Šã€ã²ã¨ã“ã¨æ¬„ã§å‹˜å¼ã—ã¦ãã ã•ã„ã€‚</p>
        <p>ãªãŠã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ãŸã‚Šã€åé›†ã—ãŸã‚Šã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ç”»åƒå‡¦ç†ã¯ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆJavaScriptï¼‰ã§å®Œçµã—ã¦ã„ã¾ã™ã®ã§ã€ã”å®‰å¿ƒãã ã•ã„ã€‚ã¾ãŸã€ã“ã®HTMLã‚³ãƒ¼ãƒ‰ã¯Googleã®Geminiã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚</p>
        <div class="version-info">
            <p>æœ€çµ‚æ›´æ–°æ—¥: 2025/05/31</p>
            <p>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.1.1</p>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            const imageUpload = document.getElementById('imageUpload');
            const fileListDiv = document.getElementById('fileList');
            const rowsContainer = document.getElementById('rowsContainer');
            const generateButton = document.getElementById('generateButton');
            const resultCanvas = document.getElementById('resultCanvas');
            const downloadLink = document.getElementById('downloadLink');
            const ctx = resultCanvas.getContext('2d');
            const commentInput = document.getElementById('commentInput');

            // åˆ‡ã‚Šå‡ºã—è¨­å®šã®Inputè¦ç´ 
            const cropSxInput = document.getElementById('cropSx');
            const cropSOpponentYInput = document.getElementById('cropSOpponentY');
            const cropSSelfYInput = document.getElementById('cropSSelfY');
            const cropSHeightInput = document.getElementById('cropSHeight');

            let sortedFiles = [];
            let imageDimensions = { width: 0, height: 0 }; // æœ€åˆã®ç”»åƒã®è§£åƒåº¦ã‚’ä¿æŒ

            // --- å‡ºåŠ›ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š (ã“ã‚Œã‚‰ã¯å‹•çš„ã«è¨­å®š) ---
            let FINAL_CANVAS_WIDTH = 0; // å…¥åŠ›ç”»åƒã®å¹…ã«åŸºã¥ã„ã¦å‹•çš„ã«è¨­å®š
            const CANVAS_PADDING = 25; // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° (ä¸Šã€å³ã€ä¸‹ã€å·¦) - èª¿æ•´
            const SPACE_BETWEEN_ELEMENTS = 15; // è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹

            // â˜…MATCH_NAME_WIDTH ã®å†èª¿æ•´: è©¦åˆåã®è¡¨ç¤ºã«å¿…è¦ãªå¹…ã‚’ç¢ºä¿
            const INITIAL_MATCH_NAME_WIDTH = 150; // è©¦åˆåã«ã“ã‚Œã ã‘ã®å¹…ã‚’ç¢ºä¿ (ãƒ”ã‚¯ã‚»ãƒ«)
            let MATCH_NAME_WIDTH = INITIAL_MATCH_NAME_WIDTH; // å‹•çš„ã«è¨­å®šã•ã‚Œã‚‹ãŒã€åˆæœŸå€¤ã¨ã—ã¦

            let DEST_ICON_STRIP_WIDTH = 0; // FINAL_CANVAS_WIDTHã«åŸºã¥ã„ã¦å‹•çš„ã«è¨­å®š
            // DEST_ICON_STRIP_HEIGHT ã¯å‹•çš„ã«è¨ˆç®—ã•ã‚Œã¾ã™

            const POINTS_AREA_WIDTH_RATIO = 0.15; // ç²å¾—æˆ¦ç¸¾è¡¨ç¤ºé ˜åŸŸã®å¹…ã®æ¯”ç‡
            let POINTS_AREA_WIDTH = 0; // å‹•çš„ã«è¨­å®š
            let POINTS_TEXT_SIZE = 24; // ãƒã‚¤ãƒ³ãƒˆã®æ–‡å­—ã‚µã‚¤ã‚º (å‹•çš„ã«èª¿æ•´ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š)

            const HEADER_TEXT_Y_OFFSET = 50; // Yä½ç½®ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ (ä¸Šã‹ã‚‰ã®è·é›¢)
            let HEADER_TEXT_SIZE = 18; // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ–‡å­—ã‚µã‚¤ã‚º (å‹•çš„ã«èª¿æ•´ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š)
            let COPYRIGHT_TEXT_SIZE = 12; // ä½œæˆæ—¥ãƒ†ã‚­ã‚¹ãƒˆã®ã‚µã‚¤ã‚º (å‹•çš„ã«èª¿æ•´ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š)
            let COMMENT_TEXT_SIZE = 18; // ã²ã¨ã“ã¨ãƒ†ã‚­ã‚¹ãƒˆã®ã‚µã‚¤ã‚º (äºˆé¸/æœ¬æˆ¦ã¨åŒã˜ãã‚‰ã„)
            const COMMENT_LINE_HEIGHT_FACTOR = 1.5; // ã‚³ãƒ¡ãƒ³ãƒˆã®è¡Œã®é«˜ã•ã®æ¯”ç‡
            
            // â˜…ã‚³ãƒ¡ãƒ³ãƒˆã‚¨ãƒªã‚¢ã¨è‘—ä½œæ¨©è¡¨ç¤ºã®é–“ã®ä½™ç™½ã‚’å†åº¦èª¿æ•´ (ã²ã¨ã“ã¨ã®å‡ºåŠ›ä½ç½®)
            // ä»¥å‰ã€Œã‚³ãƒ¡ãƒ³ãƒˆä¸Šéƒ¨ã®ä½™ç™½: COMMENT_AREA_BOTTOM_MARGIN ã®å€¤ã‚’èª¿æ•´ã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¨ãƒªã‚¢å…¨ä½“ã®é«˜ã•ã‚’è¨ˆç®—ã™ã‚‹éš›ã« commentAreaDrawingHeight ã‚’å¢—ã‚„ã™ã“ã¨ã§ã€åŠ å·¥ç”»åƒã‹ã‚‰ã®è·é›¢ã‚’å€ç¨‹åº¦ã«åºƒã’ã¾ã—ãŸã€‚ã€ã¨ã„ã†çŠ¶æ…‹ã‚’å†ç¾
            let COMMENT_AREA_MARGIN_AFTER_LAST_ROW = 50; // æœ€å¾Œã®ç”»åƒè¡Œã®ä¸‹ç«¯ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã®é–‹å§‹Yã¾ã§ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´
            let COMMENT_AREA_BOTTOM_MARGIN = 60; // ã‚³ãƒ¡ãƒ³ãƒˆã‚¨ãƒªã‚¢ã¨è‘—ä½œæ¨©è¡¨ç¤ºã®é–“ã®ä½™ç™½

            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’é™¤ã„ãŸã€æœ€åˆã®ãƒ‡ãƒ¼ã‚¿è¡Œã®Yé–‹å§‹ä½ç½®
            let ROW_CONTENT_Y_START = HEADER_TEXT_Y_OFFSET + HEADER_TEXT_SIZE + 30; // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã®ä¸‹ã«ã‚¹ãƒšãƒ¼ã‚¹
            const ROW_SPACING = 15; // è¡Œé–“ã®ã‚¹ãƒšãƒ¼ã‚¹
            // ROW_HEIGHT ã¯å‹•çš„ã«è¨ˆç®—ã•ã‚Œã¾ã™

            let FINAL_CANVAS_HEIGHT = 0; // å…¨ä½“ã®é«˜ã•ã¯å‹•çš„ã«è¨ˆç®—ã•ã‚Œã¾ã™
            // -------------------------

            imageUpload.addEventListener('change', handleFiles);
            generateButton.addEventListener('click', generateImage);

            // å¢—æ¸›ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            document.querySelectorAll('.increment-btn, .decrement-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const targetId = event.target.dataset.target;
                    const inputElement = document.getElementById(targetId);
                    if (inputElement) {
                        let currentValue = parseFloat(inputElement.value);
                        const min = parseFloat(inputElement.min);
                        const max = parseFloat(inputElement.max);
                        const step = 1; // 1ãšã¤å¢—æ¸›

                        if (event.target.classList.contains('increment-btn')) {
                            currentValue += step;
                            if (currentValue > max) currentValue = max;
                        } else if (event.target.classList.contains('decrement-btn')) {
                            currentValue -= step;
                            if (currentValue < min) currentValue = min;
                        }
                        inputElement.value = currentValue;
                    }
                });
            });


            function handleFiles(event) {
                const files = Array.from(event.target.files);
                fileListDiv.innerHTML = ''; // Clear previous file list
                rowsContainer.innerHTML = '<p class="info">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã“ã“ã«è¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>'; // Reset settings UI
                generateButton.disabled = true;
                downloadLink.style.display = 'none'; // Hide download link
                resultCanvas.height = 0; // Clear canvas preview by reducing its height

                // ãƒ•ã‚¡ã‚¤ãƒ«æšæ•°åˆ¶é™ã‚’3-7æšã«æ›´æ–°
                if (files.length < 3 || files.length > 7) {
                    alert('3æšã‹ã‚‰7æšã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    imageUpload.value = ''; // Reset file input
                    sortedFiles = [];
                    return;
                }

                sortedFiles = files.sort((a, b) => a.name.localeCompare(b.name));

                // æœ€åˆã®ç”»åƒã‹ã‚‰è§£åƒåº¦ã‚’å–å¾—
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.onload = () => {
                        imageDimensions = { width: img.width, height: img.height };

                        // â˜…FINAL_CANVAS_WIDTHã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’èª¿æ•´ (ä½™ç™½1-2å‰²ç¨‹åº¦)
                        // å…ƒã®ç”»åƒã®å¹…ã«å¯¾ã—ã¦ã€ä¾‹ãˆã°1.8å€ç¨‹åº¦ã®æ¯”ç‡ã§æœ€çµ‚ã‚­ãƒ£ãƒ³ãƒã‚¹å¹…ã‚’è¨­å®š
                        // ã“ã‚Œã«ã‚ˆã‚Šã€å·¦å³ã«é©åˆ‡ãªä½™ç™½ãŒç¢ºä¿ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                        FINAL_CANVAS_WIDTH = Math.floor(imageDimensions.width * 1.8); // 1.6å€ã‹ã‚‰1.8å€ã«å¢—åŠ 

                        // ãŸã ã—ã€æœ€ä½é™ã®å¹…ã‚‚ç¢ºä¿
                        if (FINAL_CANVAS_WIDTH < 700) FINAL_CANVAS_WIDTH = 700; // æœ€ä½å¹…ã‚‚å°‘ã—åºƒã’ã‚‹

                        // MATCH_NAME_WIDTH ã¯ FINAL_CANVAS_WIDTH ã«å¿œã˜ã¦èª¿æ•´
                        // ä¾‹ãˆã°ã€FINAL_CANVAS_WIDTHã®ç´„20%ã‚’è©¦åˆåã«å‰²ã‚Šå½“ã¦ã‚‹
                        MATCH_NAME_WIDTH = Math.floor(FINAL_CANVAS_WIDTH * 0.2);
                        if (MATCH_NAME_WIDTH < 150) MATCH_NAME_WIDTH = 150; // æœ€ä½150pxç¢ºä¿

                        POINTS_AREA_WIDTH = Math.floor(FINAL_CANVAS_WIDTH * POINTS_AREA_WIDTH_RATIO);

                        // DEST_ICON_STRIP_WIDTH ã‚‚é€£å‹•ã—ã¦èª¿æ•´
                        DEST_ICON_STRIP_WIDTH = Math.floor((FINAL_CANVAS_WIDTH - (CANVAS_PADDING * 2) - MATCH_NAME_WIDTH - (SPACE_BETWEEN_ELEMENTS * 2) - POINTS_AREA_WIDTH) / 2);
                        // ãŸã ã—ã€å°ã•ããªã‚Šã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€æœ€ä½å€¤ã‚’è¨­ã‘ã‚‹
                        if (DEST_ICON_STRIP_WIDTH < 150) DEST_ICON_STRIP_WIDTH = 150;


                        // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚‚å‹•çš„ã«èª¿æ•´ï¼ˆä¾‹ã¨ã—ã¦ã€å¹…ã«æ¯”ä¾‹ã—ã¦èª¿æ•´ï¼‰
                        const widthRatio = FINAL_CANVAS_WIDTH / 750;
                        POINTS_TEXT_SIZE = Math.max(20, Math.floor(28 * widthRatio));
                        HEADER_TEXT_SIZE = Math.max(16, Math.floor(20 * widthRatio));
                        COPYRIGHT_TEXT_SIZE = Math.max(11, Math.floor(14 * widthRatio));
                        COMMENT_TEXT_SIZE = Math.max(16, Math.floor(20 * widthRatio)); // ã²ã¨ã“ã¨ã‚‚å‹•çš„ã«èª¿æ•´

                        ROW_CONTENT_Y_START = HEADER_TEXT_Y_OFFSET + HEADER_TEXT_SIZE + 30;

                        updateUIForSettings(sortedFiles.length);
                        generateButton.disabled = false;
                    };
                    img.onerror = () => {
                        alert('æœ€åˆã®ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        imageUpload.value = '';
                        sortedFiles = [];
                        generateButton.disabled = true;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(sortedFiles[0]);
            }

            function getMatchName(index, totalImages) {
                if (totalImages === 7) { // ã‚®ãƒ«ãƒ‰å¤§ä¼š
                    return (index < 4) ? `äºˆé¸ ç¬¬${index + 1}è©¦åˆ` : `æœ¬æˆ¦ ç¬¬${index - 3}è©¦åˆ`;
                } else if (totalImages === 6) { // å€‹äººãƒªãƒ¼ã‚°
                    return (index < 3) ? `äºˆé¸ ç¬¬${index + 1}è©¦åˆ` : `æœ¬æˆ¦ ç¬¬${index - 2}è©¦åˆ`;
                } else { // 3ï½5æšã®å ´åˆ
                    return `ç¬¬${index + 1}è©¦åˆ`;
                }
            }


            function updateUIForSettings(numImages) {
                const p = document.createElement('p');
                p.innerHTML = '<strong>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ« (å‡¦ç†é †):</strong>';
                fileListDiv.appendChild(p);

                const ol = document.createElement('ol');
                sortedFiles.forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = file.name;
                    ol.appendChild(li);
                });
                fileListDiv.appendChild(ol);

                rowsContainer.innerHTML = '';
                // rowsContainer.innerHTML = '<p class="info">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã“ã“ã«è¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
                // if (sortedFiles.length > 0) {
                //     rowsContainer.innerHTML = '';
                // }


                sortedFiles.forEach((file, index) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.classList.add('row-setting');

                    // è©¦åˆåã¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã¾ã¨ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ
                    const matchFileInfoDiv = document.createElement('div');
                    matchFileInfoDiv.classList.add('match-file-info');

                    const matchNameSpan = document.createElement('span');
                    matchNameSpan.classList.add('match-name-display');
                    matchNameSpan.textContent = getMatchName(index, numImages);
                    matchFileInfoDiv.appendChild(matchNameSpan);

                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.classList.add('file-name-display');
                    fileNameSpan.textContent = `(${file.name})`;
                    fileNameSpan.title = file.name;
                    matchFileInfoDiv.appendChild(fileNameSpan);

                    rowDiv.appendChild(matchFileInfoDiv);

                    // ãƒã‚¤ãƒ³ãƒˆè¨­å®šéƒ¨åˆ†ã‚’ã¾ã¨ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ
                    const pointsSettingDiv = document.createElement('div');
                    pointsSettingDiv.classList.add('points-setting');

                    const label = document.createElement('label');
                    label.setAttribute('for', `points-${index}`);
                    label.textContent = 'ãƒã‚¤ãƒ³ãƒˆ:';

                    const select = document.createElement('select');
                    select.id = `points-${index}`;

                    // 10Pã‚’æœ€åˆã®é¸æŠè‚¢ã¨ã—ã¦è¿½åŠ 
                    const option10 = document.createElement('option');
                    option10.value = "10";
                    option10.textContent = "10P";
                    select.appendChild(option10);

                    // 100Pã‹ã‚‰160Pã¾ã§5Påˆ»ã¿ã§é¸æŠè‚¢ã‚’è¿½åŠ 
                    for (let pVal = 100; pVal <= 160; pVal += 5) {
                        const option = document.createElement('option');
                        option.value = pVal;
                        option.textContent = `${pVal}P`;
                        select.appendChild(option);
                    }
                    select.value = "160"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§160Pã‚’é¸æŠ

                    pointsSettingDiv.appendChild(label);
                    pointsSettingDiv.appendChild(select);
                    rowDiv.appendChild(pointsSettingDiv);

                    rowsContainer.appendChild(rowDiv);
                });
            }

            async function generateImage() {
                const numImages = sortedFiles.length;
                const userComment = commentInput.value.trim(); // ã²ã¨ã“ã¨æ¬„ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—

                if (numImages < 3 || numImages > 7 || imageDimensions.width === 0) {
                    alert('ç”»åƒãŒæ­£ã—ãé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ã€ç”»åƒã®è§£åƒåº¦ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚\n(3æšã‹ã‚‰7æšã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„)');
                    return;
                }
                generateButton.disabled = true;
                generateButton.textContent = "ç”Ÿæˆä¸­...";
                downloadLink.style.display = 'none';

                // %å€¤ã‹ã‚‰å®Ÿéš›ã®ãƒ”ã‚¯ã‚»ãƒ«å€¤ã‚’è¨ˆç®—
                const cropSxPercent = parseFloat(cropSxInput.value) / 100;
                const cropSOpponentYPercent = parseFloat(cropSOpponentYInput.value) / 100;
                const cropSSelfYPercent = parseFloat(cropSSelfYInput.value) / 100;
                const cropSHeightPercent = parseFloat(cropSHeightInput.value) / 100;

                const sx = imageDimensions.width * cropSxPercent;
                const sWidth = imageDimensions.width * (1 - 2 * cropSxPercent); // ä¸¡ç«¯ã®ä½™ç™½ã‚’å¼•ã
                const sHeight = imageDimensions.height * cropSHeightPercent;

                const syOpponent = imageDimensions.height * cropSOpponentYPercent;
                const sySelf = imageDimensions.height * cropSSelfYPercent;

                // å‡ºåŠ›ã§ã®ç›¸æ‰‹ãƒ»è‡ªåˆ†ã®ç”»åƒé«˜ã•ã‚‚è¨ˆç®—
                const DEST_ICON_STRIP_HEIGHT = DEST_ICON_STRIP_WIDTH * (sHeight / sWidth);
                const ROW_HEIGHT = DEST_ICON_STRIP_HEIGHT;

                let commentAreaDrawingHeight = 0;
                let commentLines = [];
                if (userComment) {
                    ctx.font = `bold ${COMMENT_TEXT_SIZE}px "Meiryo", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif`; // â˜…ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ãƒ¡ã‚¤ãƒªã‚ªã«
                    // ã‚³ãƒ¡ãƒ³ãƒˆã®æç”»å¹…ã‚’èª¿æ•´: å·¦å³ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸæœ€å¤§å¹…
                    const maxWidth = FINAL_CANVAS_WIDTH - (CANVAS_PADDING * 2);

                    const words = userComment.split(' ');
                    let line = '';
                    
                    for (let n = 0; n < words.length; n++) {
                        let testLine = line + words[n] + ' ';
                        let metrics = ctx.measureText(testLine);
                        let testWidth = metrics.width;
                        if (testWidth > maxWidth && n > 0) {
                            commentLines.push(line.trim()); // å„è¡Œã®æœ«å°¾ã®ç©ºç™½ã‚’å‰Šé™¤
                            line = words[n] + ' ';
                        } else {
                            line = testLine;
                        }
                    }
                    commentLines.push(line.trim()); // æœ€å¾Œã®è¡Œã‚‚è¿½åŠ ã—ã€æœ«å°¾ã®ç©ºç™½ã‚’å‰Šé™¤
                    commentAreaDrawingHeight = commentLines.length * COMMENT_TEXT_SIZE * COMMENT_LINE_HEIGHT_FACTOR;
                }

                // ä½œæˆæ—¥ã®è¡¨ç¤ºã‚¹ãƒšãƒ¼ã‚¹ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã€FINAL_CANVAS_HEIGHTã‚’èª¿æ•´
                // currentY ã¯æœ€å¾Œã®è¡ŒãŒæç”»ã•ã‚ŒãŸç›´å¾Œã®Yåº§æ¨™ãªã®ã§ã€ãã“ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã®é–‹å§‹Yåº§æ¨™ã‚’è¨ˆç®—
                FINAL_CANVAS_HEIGHT = ROW_CONTENT_Y_START + (numImages * (ROW_HEIGHT + ROW_SPACING)) - ROW_SPACING; // æœ€å¾Œã®è¡Œã®ä¸‹ç«¯ã¾ã§
                if (userComment) {
                    FINAL_CANVAS_HEIGHT += COMMENT_AREA_MARGIN_AFTER_LAST_ROW; // æœ€å¾Œã®ç”»åƒè¡Œã¨ã‚³ãƒ¡ãƒ³ãƒˆã®é–“ã®ä½™ç™½
                    FINAL_CANVAS_HEIGHT += commentAreaDrawingHeight; // ã‚³ãƒ¡ãƒ³ãƒˆã®å®Ÿéš›ã®é«˜ã•
                }
                FINAL_CANVAS_HEIGHT += COMMENT_AREA_BOTTOM_MARGIN; // ã‚³ãƒ¡ãƒ³ãƒˆã‚¨ãƒªã‚¢ã¨è‘—ä½œæ¨©è¡¨ç¤ºã®é–“ã®ä½™ç™½
                FINAL_CANVAS_HEIGHT += COPYRIGHT_TEXT_SIZE; // è‘—ä½œæ¨©è¡¨ç¤ºã®é«˜ã•
                FINAL_CANVAS_HEIGHT += CANVAS_PADDING; // ä¸‹éƒ¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°


                resultCanvas.width = FINAL_CANVAS_WIDTH;
                resultCanvas.height = FINAL_CANVAS_HEIGHT;

                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, resultCanvas.width, resultCanvas.height);

                ctx.fillStyle = '#333';
                // ãƒ•ã‚©ãƒ³ãƒˆã‚’æ˜æœä½“ã¾ãŸã¯Rolaã«è¿‘ã¥ã‘ã‚‹è¨­å®š
                ctx.font = `bold ${HEADER_TEXT_SIZE}px "Hiragino Mincho ProN", "MS Mincho", "Rola", serif`;
                ctx.textBaseline = 'middle';

                // å„ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½ç½®ã‚’èª¿æ•´
                // è©¦åˆåã‚«ãƒ©ãƒ ã®Xåº§æ¨™ (CANVAS_PADDING + MATCH_NAME_WIDTH / 2)
                const matchNameColX = CANVAS_PADDING + MATCH_NAME_WIDTH / 2;

                const opponentColX = CANVAS_PADDING + MATCH_NAME_WIDTH + SPACE_BETWEEN_ELEMENTS + DEST_ICON_STRIP_WIDTH / 2;

                // æŒ‘æˆ¦ãƒ‘ãƒ¼ãƒ†ã‚£ã®æ–‡å­—ã®Xåº§æ¨™ã‚’èª¿æ•´ (ç›¸æ‰‹ãƒ‘ãƒ¼ãƒ†ã‚£ã®ç”»åƒã®å³ç«¯ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç©ºã‘ã¦é…ç½®)
                const selfColX = CANVAS_PADDING + MATCH_NAME_WIDTH + SPACE_BETWEEN_ELEMENTS + DEST_ICON_STRIP_WIDTH + SPACE_BETWEEN_ELEMENTS + DEST_ICON_STRIP_WIDTH / 2;

                // ç²å¾—æˆ¦ç¸¾ã®Xåº§æ¨™ã‚’èª¿æ•´ï¼ˆå³å¯„ã›ã§ã€Pã®ä½ç½®ãŒç¸¦ã«æƒã†ã‚ˆã†ã«ï¼‰
                // FINAL_CANVAS_WIDTHã‹ã‚‰å³å´ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¼•ã„ãŸä½ç½®ã«ãƒ†ã‚­ã‚¹ãƒˆã®å³ç«¯ã‚’åˆã‚ã›ã‚‹
                const pointsColX = FINAL_CANVAS_WIDTH - CANVAS_PADDING;

                ctx.textAlign = 'center';
                ctx.fillText('ç›¸æ‰‹ã®é˜²è¡›ãƒ‘ãƒ¼ãƒ†ã‚£', opponentColX, HEADER_TEXT_Y_OFFSET);
                ctx.fillText('æŒ‘æˆ¦ãƒ‘ãƒ¼ãƒ†ã‚£', selfColX, HEADER_TEXT_Y_OFFSET);

                ctx.textAlign = 'right';
                ctx.fillText('ç²å¾—æˆ¦ç¸¾', pointsColX, HEADER_TEXT_Y_OFFSET);


                let currentY = ROW_CONTENT_Y_START;

                for (let i = 0; i < numImages; i++) {
                    const file = sortedFiles[i];
                    const pointsInput = document.getElementById(`points-${i}`);
                    if (!pointsInput) {
                        console.error(`Points input for index ${i} not found`);
                        currentY += ROW_HEIGHT + ROW_SPACING;
                        continue;
                    }
                    const pointsValue = parseInt(pointsInput.value);
                    const pointsText = `${pointsValue}P`;


                    const cropOpponentDetails = { sx: sx, sy: syOpponent, sWidth: sWidth, sHeight: sHeight };
                    const cropSelfDetails = { sx: sx, sy: sySelf, sWidth: sWidth, sHeight: sHeight };

                    try {
                        const opponentImg = await cropAndLoadImage(file, cropOpponentDetails);
                        const selfImg = await cropAndLoadImage(file, cropSelfDetails);

                        // ã€Œäºˆé¸ ç¬¬Xè©¦åˆã€ã€Œæœ¬æˆ¦ ç¬¬Xè©¦åˆã€ã®æç”»
                        ctx.fillStyle = '#333';
                        ctx.font = `bold ${HEADER_TEXT_SIZE * 0.9}px "Hiragino Mincho ProN", "MS Mincho", "Rola", serif`;
                        ctx.textAlign = 'center';

                        const matchName = getMatchName(i, numImages);
                        // è©¦åˆåã®æç”»ä½ç½®ã‚’èª¿æ•´
                        ctx.fillText(matchName, matchNameColX, currentY + ROW_HEIGHT / 2);


                        // ç”»åƒã®æç”»ä½ç½®ã‚’èª¿æ•´
                        const opponentDrawX = CANVAS_PADDING + MATCH_NAME_WIDTH + SPACE_BETWEEN_ELEMENTS;
                        ctx.drawImage(opponentImg, opponentDrawX, currentY, DEST_ICON_STRIP_WIDTH, DEST_ICON_STRIP_HEIGHT);

                        // æŒ‘æˆ¦ãƒ‘ãƒ¼ãƒ†ã‚£ã®æç”»ä½ç½®ã‚’èª¿æ•´
                        const selfDrawX = opponentDrawX + DEST_ICON_STRIP_WIDTH + SPACE_BETWEEN_ELEMENTS;
                        ctx.drawImage(selfImg, selfDrawX, currentY, DEST_ICON_STRIP_WIDTH, DEST_ICON_STRIP_HEIGHT);

                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'middle';
                        ctx.font = `bold ${POINTS_TEXT_SIZE}px "Hiragino Mincho ProN", "MS Mincho", "Rola", serif`;
                        ctx.fillStyle = getPointColor(pointsValue);
                        // ç²å¾—æˆ¦ç¸¾ã®æç”»ä½ç½®ã‚’èª¿æ•´
                        ctx.fillText(pointsText, pointsColX, currentY + ROW_HEIGHT / 2);


                    } catch (error) {
                        console.error(`Error processing file ${file.name}:`, error);
                        ctx.fillStyle = 'red';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText(`ã‚¨ãƒ©ãƒ¼: ${file.name.substring(0,15)}...`, CANVAS_PADDING, currentY + ROW_HEIGHT / 2);
                    }
                    currentY += ROW_HEIGHT + ROW_SPACING;
                }
                // æœ€å¾Œã®æç”»å¾Œã® currentY ã¯ã€æœ€å¾Œã®ç”»åƒã®Yåº§æ¨™+é«˜ã•+è¡Œé–“ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€
                // æœ€å¾Œã®ç”»åƒã®åº•è¾ºã¯ currentY - ROW_SPACING ã§ã™ã€‚

                // ã²ã¨ã“ã¨ã‚³ãƒ¡ãƒ³ãƒˆã®æç”»
                if (userComment && commentLines.length > 0) {
                    ctx.fillStyle = '#333';
                    ctx.font = `bold ${COMMENT_TEXT_SIZE}px "Meiryo", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif`; // â˜…ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ãƒ¡ã‚¤ãƒªã‚ªã«
                    ctx.textAlign = 'left';
                    // ä¿®æ­£ç‚¹: ã‚³ãƒ¡ãƒ³ãƒˆã®Xåº§æ¨™ã‚’ã€Œç›¸æ‰‹ã®é˜²è¡›ãƒ‘ãƒ¼ãƒ†ã‚£ã€ã®ç”»åƒé–‹å§‹ä½ç½®ã«åˆã‚ã›ã‚‹
                    let commentX = CANVAS_PADDING + MATCH_NAME_WIDTH + SPACE_BETWEEN_ELEMENTS;
                    
                    // ã‚³ãƒ¡ãƒ³ãƒˆã®æç”»é–‹å§‹Yåº§æ¨™ã‚’ã€æœ€å¾Œã®ç”»åƒã®è¡¨ç¤ºçµ‚äº†ä½ç½® (currentY - ROW_SPACING) ã‹ã‚‰
                    // æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ³ COMMENT_AREA_MARGIN_AFTER_LAST_ROW ã‚’åŠ ãˆãŸä½ç½®ã«è¨­å®š
                    // ã•ã‚‰ã«ã€ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã®é–‹å§‹ä½ç½®ã‚’è€ƒæ…®ã—ã¦COMMENT_TEXT_SIZE * COMMENT_LINE_HEIGHT_FACTOR / 2 ã‚’åŠ ãˆã‚‹
                    let commentY = (currentY - ROW_SPACING) + COMMENT_AREA_MARGIN_AFTER_LAST_ROW + (COMMENT_TEXT_SIZE * COMMENT_LINE_HEIGHT_FACTOR / 2);
                    
                    for (let j = 0; j < commentLines.length; j++) {
                        ctx.fillText(commentLines[j], commentX, commentY + (j * COMMENT_TEXT_SIZE * COMMENT_LINE_HEIGHT_FACTOR));
                    }
                    // ã‚³ãƒ¡ãƒ³ãƒˆæç”»å¾Œã€currentYã‚’æ›´æ–°ã—ã¦ã€è‘—ä½œæ¨©è¡¨ç¤ºã®ä½ç½®ã‚’æ­£ã—ãè¨ˆç®—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                    currentY = commentY + (commentLines.length * COMMENT_TEXT_SIZE * COMMENT_LINE_HEIGHT_FACTOR);
                }


                // å³ä¸‹ã«ä½œæˆæ—¥ã‚’è¡¨ç¤º (Created onYYYY/MM/DD å½¢å¼ã«æˆ»ã™)
                ctx.fillStyle = '#777';
                ctx.font = `normal ${COPYRIGHT_TEXT_SIZE}px "Hiragino Mincho ProN", "MS Mincho", "Rola", serif`;
                ctx.textAlign = 'right';
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');

                // ã€ŒCreated onYYYY/MM/DDã€å½¢å¼
                const createdDateString = `Created on ${year}/${month}/${day}`;
                ctx.fillText(createdDateString, FINAL_CANVAS_WIDTH - CANVAS_PADDING, FINAL_CANVAS_HEIGHT - CANVAS_PADDING);

                // ãƒ•ã‚¡ã‚¤ãƒ«åã«æ—¥æ™‚ã‚’è¿½åŠ 
                const hours = today.getHours().toString().padStart(2, '0');
                const minutes = today.getMinutes().toString().padStart(2, '0');
                const dateStringForFilename = `${year}${month}${day}${hours}${minutes}`;
                downloadLink.href = resultCanvas.toDataURL('image/png', 1.0);
                downloadLink.download = `DQTACT_BattleLogSummary_${dateStringForFilename}.png`;
                downloadLink.style.display = 'block';
                generateButton.disabled = false;
                generateButton.textContent = "ç”»åƒã‚’ç”Ÿæˆ âœ¨";
            }

            function cropAndLoadImage(imageFile, cropDetails) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const tempCanvas = document.createElement('canvas');
                            const tempCtx = tempCanvas.getContext('2d');
                            if (cropDetails.sWidth <= 0 || cropDetails.sHeight <= 0) {
                                return reject(new Error("åˆ‡ã‚Šå‡ºã—ç¯„å›²ã®å¹…ã¾ãŸã¯é«˜ã•ãŒç„¡åŠ¹ã§ã™ã€‚"));
                            }
                            tempCanvas.width = cropDetails.sWidth;
                            tempCanvas.height = cropDetails.sHeight;
                            try {
                                tempCtx.drawImage(img,
                                    cropDetails.sx, cropDetails.sy,
                                    cropDetails.sWidth, cropDetails.sHeight,
                                    0, 0,
                                    cropDetails.sWidth, cropDetails.sHeight
                                );
                                const croppedImage = new Image();
                                croppedImage.onload = () => resolve(croppedImage);
                                croppedImage.onerror = (err) => reject(new Error("åˆ‡ã‚Šå‡ºã—ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:" + err));
                                croppedImage.src = tempCanvas.toDataURL();
                            } catch (drawError) {
                                reject(new Error(`å…ƒç”»åƒã®æç”»ã‚¨ãƒ©ãƒ¼: ${drawError.message}`));
                            }
                        };
                        img.onerror = () => reject(new Error("å…ƒç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€ã‚µãƒãƒ¼ãƒˆå¤–ã®å½¢å¼ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"));
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject(new Error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ã€‚"));
                    reader.readAsDataURL(imageFile);
                });
            }

            function getPointColor(pointsValue) {
                // ç¾çŠ¶ã®ã‚«ãƒ©ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ
                if (pointsValue === 10) return 'red';

                const orange = { r: 255, g: 165, b: 0 };
                const blue = { r: 0, g: 0, b: 255 };
                const purpleish = { r: 160, g: 0, b: 200 };

                const minPoints = 100;
                const maxPoints = 160;

                const clampedPoints = Math.max(minPoints, Math.min(maxPoints, pointsValue));

                let r, g, b;

                if (clampedPoints <= 155) {
                    const ratio = (clampedPoints - minPoints) / (155 - minPoints);
                    r = Math.round(orange.r * (1 - ratio) + purpleish.r * ratio);
                    g = Math.round(orange.g * (1 - ratio) + purpleish.g * ratio);
                    b = Math.round(orange.b * (1 - ratio) + purpleish.b * ratio);
                } else {
                    const ratio = (clampedPoints - 155) / (maxPoints - 155);
                    r = Math.round(purpleish.r * (1 - ratio) + blue.r * ratio);
                    g = Math.round(purpleish.g * (1 - ratio) + blue.g * ratio);
                    b = Math.round(purpleish.b * (1 - ratio) + blue.b * ratio);
                }

                return `rgb(${r}, ${g}, ${b})`;
            }
        });
    </script>
</body>
</html>
