<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQTact ステータス計算機</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding-top: 1rem;
            padding-bottom: 3rem;
            padding-left: 0.25rem;
            padding-right: 0.25rem;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            font-size: 16px;
        }
        .main-title {
            text-align: center;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .main-title h1 {
            font-size: clamp(1.5rem, 4.5vw, 2.2rem);
            font-weight: 800;
            color: transparent;
            background-image: linear-gradient(to right, #3b82f6, #4f46e5);
            -webkit-background-clip: text;
            background-clip: text;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .status-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: #10b981; /* エメラルドグリーン */
        }
        .status-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4b5563;
        }
    </style>
</head>
<body>
    <div class="main-title">
        <h1 class="bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-indigo-600">
            DQTact ステータス計算機
        </h1>
        <h2 id="charNameDisplay" class="text-xl font-bold text-gray-700 mt-1"></h2>
    </div>

    <div class="container flex flex-col space-y-6">
        
        <div class="w-full bg-blue-50 p-4 rounded-lg shadow-inner">
            <label for="characterSelect" class="block text-base font-semibold text-gray-700 mb-2">
                キャラクターを選択:
            </label>
            <select id="characterSelect" onchange="updateCalculation()" 
                    class="w-full p-3 border border-blue-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg">
                <option value="" disabled selected>データを読み込み中...</option>
            </select>
        </div>

        <div class="w-full bg-indigo-50 p-4 rounded-lg shadow-inner">
            <label for="awakeningLevel" class="block text-base font-semibold text-gray-700 mb-2">
                覚醒段階 (凸数) を選択:
            </label>
            <select id="awakeningLevel" onchange="updateCalculation()" 
                    class="w-full p-3 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg" disabled>
                <option value="5" selected>5凸 (完凸)</option>
            </select>
        </div>

        <div class="w-full bg-white p-4 rounded-lg shadow-lg border border-gray-100">
            <h3 class="text-lg font-bold mb-3 text-gray-800 border-b pb-2">最終ステータス (Lv Max)</h3>
            <div id="statusResults" class="grid grid-cols-3 gap-y-4 gap-x-2 text-center">
                </div>
        </div>
        
    </div>

    <div class="author-info">
        <p class="mt-4 text-sm text-gray-500 text-center">
            このツールは、ゲーム内サイトの解析に基づき、ステータス計算ロジックを再現していますが、
            <br>
            <b>計算の正確性やゲーム内データとの完全一致を保証するものではありません。</b> <br>
            本ツールの利用によって生じた<b>闘技場での失点やその他の損害について、作者は一切責任を負いません。</b>
        </p>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. グローバル変数と定数 
        // ----------------------------------------------------
        const DATA_SOURCE_URL = './status.json'; 
        
        // 全キャラクターのマスターデータ
        let charMasterData = []; 

        // ステータス名と対応するDOM ID
        const STATUS_MAPPING = {
            0: { key: 'HP', label: 'HP' },
            1: { key: 'MP', label: 'MP' },
            2: { key: 'ATK', label: 'こうげき力' },
            3: { key: 'DEF', label: 'しゅび力' },
            4: { key: 'AGL', label: 'すばやさ' },
            5: { key: 'WIS', label: 'かしこさ' }
        };

        const domCharSelect = document.getElementById('characterSelect');
        const domAwkLevelSelect = document.getElementById('awakeningLevel');
        const domStatusResults = document.getElementById('statusResults');
        const domCharNameDisplay = document.getElementById('charNameDisplay');


        // ----------------------------------------------------
        // 2. ステータス計算エンジン (移植版)
        // ----------------------------------------------------
        
        /**
         * DQTactのステータス計算ロジックを再現する関数
         */
        function calculateStats(baseStatus, additiveBonus, multiplierBonus) {
            const NUM_CORE_STATS = 6;
            let finalStatus = {};

            for (let i = 0; i < NUM_CORE_STATS; i++) {
                // 1. 全ての加算値の合計を計算 (基本値 + 覚醒加算値)
                const totalAdditives = baseStatus[i] + additiveBonus[i];

                // 2. 全ての倍率値の合計を計算 (基本値100%に倍率ボーナスを加える)
                const totalMultipliers = 100 + multiplierBonus[i];

                // 3. 最終計算の適用: Final = Floor(Additives * (Multipliers / 100))
                let finalValue = Math.floor(totalAdditives * (totalMultipliers / 100));
                
                // 0未満を0にする処理を再現
                if (finalValue < 0) {
                    finalValue = 0;
                }
                
                finalStatus[STATUS_MAPPING[i].key] = finalValue;
            }

            return finalStatus;
        }

        // ----------------------------------------------------
        // 3. データ取得と初期化
        // ----------------------------------------------------

        async function loadMasterData() {
            try {
                // 相対パスで同一オリジンのJSONをフェッチ
                const response = await fetch(DATA_SOURCE_URL); 
                if (!response.ok) {
                    throw new Error(`データの読み込みに失敗しました: ${response.statusText}`);
                }
                charMasterData = await response.json();
                
                // UIを初期化
                populateCharacterSelect();
                populateAwakeningSelect();

                // 初期計算を実行
                updateCalculation();

            } catch (error) {
                console.error("データの読み込みエラー:", error);
                domCharSelect.innerHTML = `<option value="" disabled selected>エラー: データが読み込めませんでした。</option>`;
                domCharNameDisplay.textContent = '計算機を利用できません';
            }
        }

        function populateCharacterSelect() {
            domCharSelect.innerHTML = '';
            charMasterData.forEach((char, index) => {
                const option = document.createElement('option');
                option.value = index; // 配列のインデックスを使用
                option.textContent = char.name_jp;
                // 不死の剣士テリーをデフォルト選択
                if (char.id === 797) { 
                    option.selected = true;
                }
                domCharSelect.appendChild(option);
            });
            domCharSelect.disabled = false;
        }

        function populateAwakeningSelect() {
            domAwkLevelSelect.innerHTML = '';
            // 0凸から5凸まで
            for (let level = 0; level <= 5; level++) {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `${level}凸 (${level === 5 ? '完凸' : level === 0 ? '無覚醒' : level + '段階覚醒'})`;
                // 5凸をデフォルト選択
                if (level === 5) { 
                    option.selected = true;
                }
                domAwkLevelSelect.appendChild(option);
            }
            domAwkLevelSelect.disabled = false;
        }

        function renderStatusTableStructure() {
            let html = '';
            for (let i = 0; i < 6; i++) {
                // ID名も衝突を避けるため "display" + キー名 の形式に
                const elementId = `display${STATUS_MAPPING[i].key}`;
                html += `
                    <div>
                        <div id="${elementId}" class="status-value">--</div>
                        <div class="status-label">${STATUS_MAPPING[i].label}</div>
                    </div>
                `;
            }
            domStatusResults.innerHTML = html;
        }
        
        // ----------------------------------------------------
        // 4. 計算実行ロジック 
        // ----------------------------------------------------

        function updateCalculation() {
            // データが読み込まれていない場合はスキップ
            if (charMasterData.length === 0 || domCharSelect.value === "") {
                renderStatusTableStructure();
                return;
            }

            const selectedCharIndex = parseInt(domCharSelect.value);
            const selectedChar = charMasterData[selectedCharIndex];
            const awakeningLevel = parseInt(domAwkLevelSelect.value);
            
            // キャラクター名の表示を更新
            domCharNameDisplay.textContent = `${selectedChar.name_jp} (No.${selectedChar.id})`;

            // 覚醒テーブルから対応するデータ行を取得
            const awakeningData = selectedChar.awakening_table.find(item => item.level === awakeningLevel);

            if (!awakeningData) {
                console.error(`覚醒レベル ${awakeningLevel} のデータが見つかりません。`);
                return;
            }

            // 最終ステータスを計算
            const results = calculateStats(
                selectedChar.base_status_at_max_level,
                awakeningData.additives,
                awakeningData.magnifiers
            );

            // 結果をDOMに反映
            for (let i = 0; i < 6; i++) {
                const statusKey = STATUS_MAPPING[i].key;
                const elementId = `display${statusKey}`;
                const element = document.getElementById(elementId);
                if (element) {
                    // 数値を3桁区切りで表示
                    element.textContent = results[statusKey].toLocaleString(); 
                }
            }
        }

        // ページロード時に実行
        window.onload = () => {
            renderStatusTableStructure(); // 最初の骨組みをレンダリング
            loadMasterData(); // データを読み込み
        };
        
    </script>
</body>
</html>
